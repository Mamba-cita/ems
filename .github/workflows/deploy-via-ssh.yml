name: Deploy to Server via SSH

on:
  workflow_dispatch:
    inputs:
      ssh_user:
        description: 'SSH user for deploy (e.g., deploy)'
        required: true
      ssh_host:
        description: 'SSH host (e.g., host13.safaricombusiness.co.ke)'
        required: true
      ssh_port:
        description: 'SSH port (leave blank for default 22)'
        required: false
      deploy_path:
        description: 'Absolute path on the server to deploy into'
        required: true
      health_url:
        description: 'Optional healthcheck URL (https://example.com/health)'
        required: false

jobs:
  deploy:
    name: SSH Deploy
    environment: production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}

      - name: Create rsync exclude file
        run: |
          cat > .deploy-ignore <<'EOF'
          .git
          .env
          vendor/
          node_modules/
          storage/*.key
          storage/framework/sessions
          storage/framework/views
          EOF

      - name: Sync files to server (manual inputs)
        env:
          SSH_USER: ${{ github.event.inputs.ssh_user }}
          SSH_HOST: ${{ github.event.inputs.ssh_host }}
          SSH_PORT: ${{ github.event.inputs.ssh_port }}
          DEPLOY_PATH: ${{ github.event.inputs.deploy_path }}
        run: |
          set -euo pipefail
          PORT_ARG=""
          if [ -n "${SSH_PORT:-}" ]; then
            PORT_ARG="-e 'ssh -p $SSH_PORT -o StrictHostKeyChecking=no'"
          fi
          echo "Syncing repository to $SSH_USER@$SSH_HOST:$DEPLOY_PATH"
          # Use rsync to transfer files efficiently
          rsync -avz --delete --exclude-from='.deploy-ignore' ./ "$SSH_USER@$SSH_HOST:$DEPLOY_PATH"

      - name: Remote deploy commands (manual inputs)
        env:
          SSH_USER: ${{ github.event.inputs.ssh_user }}
          SSH_HOST: ${{ github.event.inputs.ssh_host }}
          SSH_PORT: ${{ github.event.inputs.ssh_port }}
          DEPLOY_PATH: ${{ github.event.inputs.deploy_path }}
        run: |
          set -euo pipefail
          SSH_OPTS="-o StrictHostKeyChecking=no"
          if [ -n "${SSH_PORT:-}" ]; then SSH_OPTS="$SSH_OPTS -p ${SSH_PORT}"; fi

          REMOTE_CMD=$(cat <<'REMOTE'
          cd "${DEPLOY_PATH}"
          # Use local composer.phar if present, otherwise run composer
          if [ -f composer.phar ]; then
            php composer.phar install --no-dev --optimize-autoloader
          else
            composer install --no-dev --optimize-autoloader || true
          fi
          php artisan migrate --force || true
          php artisan config:cache || true
          php artisan route:cache || true
          REMOTE
          )

          echo "Running remote commands on $SSH_HOST"
          ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" "$REMOTE_CMD"

      - name: Optional health check
        if: always()
        env:
          HEALTH_URL: ${{ github.event.inputs.health_url }}
        run: |
          if [ -z "${HEALTH_URL:-}" ]; then
            echo "No health_url input set; skipping health check.";
            exit 0;
          fi
          echo "Health check: $HEALTH_URL"
          attempts=0
          until [ $attempts -ge 5 ]
          do
            status=$(curl -s -o /dev/null -w "%{http_code}" -k "$HEALTH_URL" || echo "000")
            echo "Attempt $((attempts+1)): HTTP $status"
            if [ "$status" = "200" ]; then
              echo "Health check passed.";
              exit 0;
            fi
            attempts=$((attempts+1))
            sleep $((2 ** attempts))
          done
          echo "Health check failed after 5 attempts.";
          exit 1
